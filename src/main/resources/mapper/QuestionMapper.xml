<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="SurveySystem.mapper.QuestionMapper">

    <resultMap id="questionResultMap" type="Question">
        <id property="questionId" column="questionId"/>
        <result property="surveyId" column="surveyId"/>
        <result property="description" column="description"/>
        <result property="type" column="type"/>
        <result property="isRequired" column="isRequired"/>
        <result property="isOpen" column="isOpen"/>
        <result property="displayType" column="displayType"/>
        <result property="isSkip" column="isSkip"/>
        <result property="createdAt" column="createdAt"/>
        <result property="updatedAt" column="updatedAt"/>
        <result property="categoryId" column="CategoryId"/>
        <result property="surveyName" column="surveyName"/>
        <result property="categoryName" column="categoryName"/>
        <result property="maxSelections" column="maxSelections"/>
        <result property="minSelections" column="minSelections"/>
        <result property="instructions" column="instructions"/>
        <result property="sortType" column="sortType"/>
        <result property="sortKey" column="sortKey"/>
    </resultMap>

    <sql id="baseQuery">
        SELECT
            q.question_id AS questionId,
            q.survey_id AS surveyId,
            q.description,
            q.type,
            q.is_required AS isRequired,
            q.is_open AS isOpen,
            q.display_type AS displayType,
            q.max_selections AS maxSelections,
            q.min_selections AS minSelections,
            q.is_skip AS isSkip,
            q.sort_type AS sortType,
            q.sort_key AS sortKey,
            q.instructions AS instructions,
            q.created_at AS createdAt,
            q.updated_at AS updatedAt,
            q.primary_category_id AS CategoryId,
            s.name AS surveyName,
            c.category_name AS categoryName
        FROM Questions q
                 JOIN Surveys s ON q.survey_id = s.survey_id
                 LEFT JOIN Category c ON q.primary_category_id = c.category_id
    </sql>

    <select id="getAllQuestions" resultMap="questionResultMap">
        <include refid="baseQuery"/>
        WHERE
        <if test="surveyId != 0">
            q.survey_id = #{surveyId} AND
        </if>
        s.created_by = #{userId}
        ORDER BY q.sort_key, q.primary_category_id
    </select>

    <select id="getQuestionsBySurveyId" resultMap="questionResultMap" parameterType="int">
        <include refid="baseQuery"/>
        WHERE q.survey_id = #{surveyId} ORDER BY q.sort_key,q.primary_category_id
    </select>

    <select id="getQuestionById" resultMap="questionResultMap" parameterType="int">
        <include refid="baseQuery"/>
        WHERE q.question_id = #{questionId}
    </select>

    <insert id="addQuestionAndReturnId" parameterType="Question" useGeneratedKeys="true" keyProperty="questionId" keyColumn="question_id">
        INSERT INTO questions
        (description, type, is_required, is_open, display_type,sort_type,sort_key,instructions,primary_category_id, survey_id, is_skip,max_selections,min_selections)
        VALUES
            (#{description}, #{type}, #{isRequired},#{isOpen},#{displayType},#{sortType},#{sortKey},
             #{instructions}, #{categoryId}, #{surveyId}, #{isSkip},#{maxSelections},#{minSelections})
    </insert>

    <update id="updateQuestion" parameterType="Question">
        UPDATE questions
        SET
            description = #{description},
            type = #{type},
            is_required = #{isRequired},
            is_open = #{isOpen},
            is_skip = #{isSkip},
            sort_type = #{sortType},
            sort_key = #{sortKey},
            instructions = #{instructions},
            survey_id = #{surveyId},
            max_selections =#{maxSelections},
            min_selections =#{minSelections},
            display_type =#{displayType},
            primary_category_id = #{categoryId}
        WHERE question_id = #{questionId}
    </update>

    <delete id="deleteQuestion" parameterType="int">
        DELETE FROM questions WHERE question_id = #{questionId}
    </delete>

    <select id="getQuestionsByPage" resultMap="questionResultMap">
        <include refid="baseQuery"/>
        <where>
            s.created_by = #{userId}
            <if test="surveyId != 0">
                AND q.survey_id = #{surveyId}
            </if>
            <if test="categoryId != 0">
                AND q.primary_category_id = #{categoryId}
            </if>
            <if test="keyword != null and keyword != ''">
                AND q.description LIKE CONCAT('%', #{keyword}, '%')
            </if>
        </where>
        ORDER BY q.survey_id, q.sort_key, q.primary_category_id
        LIMIT #{pageSize} OFFSET #{offset}
    </select>

    <select id="getQuestionCount" resultType="int">
        SELECT COUNT(*)
        FROM Questions q
        JOIN Surveys s ON q.survey_id = s.survey_id
        <where>
            s.created_by = #{userId}
            <if test="surveyId != 0">
                AND q.survey_id = #{surveyId}
            </if>
            <if test="categoryId != 0">
                AND q.primary_category_id = #{categoryId}
            </if>
            <if test="keyword != null and keyword != ''">
                AND q.description LIKE CONCAT('%', #{keyword}, '%')
            </if>
        </where>
    </select>

    <update id="updateSurveyTimestamp" parameterType="int">
        UPDATE surveys SET updated_at = NOW() WHERE survey_id = #{surveyId}
    </update>
</mapper>