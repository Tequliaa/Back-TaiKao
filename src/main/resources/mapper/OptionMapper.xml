<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="TaiExam.mapper.OptionMapper">

    <resultMap id="optionResultMap" type="Option">
        <id property="id" column="id"/>
        <result property="questionId" column="question_id"/>
        <result property="type" column="type"/>
        <result property="description" column="description"/>
        <result property="sortKey" column="sort_key"/>
        <result property="isOpenOption" column="is_open"/>
        <result property="isSkip" column="is_skip"/>
        <result property="skipTo" column="skip_to"/>
        <result property="questionName" column="question_name"/>
        <result property="checkCount" column="count"/>
    </resultMap>

    <insert id="addOption" parameterType="Option" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO Options
            (question_id, type, description, sort_key, is_open, is_skip)
        VALUES
            (#{questionId}, #{type}, #{description}, #{sortKey}, #{isOpenOption}, #{isSkip})
    </insert>

    <update id="updateOption" parameterType="Option">
        UPDATE Options SET
                           question_id = #{questionId},
                           type = #{type},
                           description = #{description},
                           is_open = #{isOpenOption},
                           is_skip = #{isSkip},
                           skip_to = #{skipTo}
        WHERE id = #{id}
    </update>

    <delete id="deleteOption" parameterType="int">
        DELETE FROM Options WHERE id = #{optionId}
    </delete>

    <select id="getOptionById" resultMap="optionResultMap" parameterType="int">
        SELECT * FROM Options WHERE id = #{optionId}
    </select>


    <!-- OptionMapper.xml -->
    <select id="getOptionsWithCheckCountByQuestionId" resultMap="optionResultMap">
        SELECT o.*,
               CASE
                   WHEN q.type = '排序' THEN (
                       SELECT AVG(r.sort_order)
                       FROM Responses r
                                JOIN Users u ON r.user_id = u.id
                       WHERE r.option_id = o.id
                         AND r.is_valid = 1
                         AND (u.department_id = #{departmentId} OR #{departmentId} = 0)
                   )
                   WHEN q.type = '评分题' THEN (
                       SELECT AVG(CAST(r.response_data AS DECIMAL))
                       FROM Responses r
                                JOIN Users u ON r.user_id = u.id
                       WHERE r.option_id = o.id
                         AND r.is_valid = 1
                         AND (u.department_id = #{departmentId} OR #{departmentId} = 0)
                   )
                   ELSE (
                       SELECT COUNT(*)
                       FROM Responses r
                                JOIN Users u ON r.user_id = u.id
                       WHERE r.option_id = o.id
                         AND r.is_valid = 1
                         AND (u.department_id = #{departmentId} OR #{departmentId} = 0)
                   )
                   END AS count
        FROM Options o
            INNER JOIN Questions q ON o.question_id = q.question_id
        WHERE o.question_id = #{questionId}
        ORDER BY
            CASE
            WHEN q.type = '排序' THEN count
            ELSE o.sort_key
        END
    </select>

    <select id="getMatrixCellCheckCount" resultType="java.util.Map">
        SELECT
            r.row_id AS rowOptionId,
            r.column_id AS colOptionId,
            COUNT(*) AS checkCount
        FROM
            Responses r
                JOIN Users u ON r.user_id = u.id
        WHERE
            r.question_id = #{questionId}
          AND r.option_id = 0  -- 选项ID为0
          AND (r.row_id IS NOT NULL OR r.column_id IS NOT NULL)  -- 关键修改：确保是矩阵题
          AND r.is_valid = 1
        <if test="departmentId != null and departmentId != 0">
            AND u.department_id = #{departmentId}
        </if>
        GROUP BY
            r.row_id, r.column_id
    </select>

    <select id="getOptionsByQuestionId" resultMap="optionResultMap" parameterType="int">
        SELECT * FROM Options WHERE question_id = #{questionId} ORDER BY sort_key
    </select>

    <!-- 获取所有选项（限制用户创建的问卷） -->
    <select id="getAllOptions" resultMap="optionResultMap">
        SELECT o.*, q.description AS question_name
        FROM options o
                 JOIN questions q ON o.question_id = q.question_id
                 JOIN exam e ON q.exam_id = e.id
        WHERE e.created_by = #{userId}
    </select>

    <!-- 分页获取选项（限制用户创建的问卷） -->
    <select id="getOptionsByPage" resultMap="optionResultMap">
        SELECT o.*, q.description AS question_name
        FROM options o
        JOIN questions q ON o.question_id = q.question_id
        JOIN exam e ON q.exam_id = e.id
        <where>
            e.created_by = #{userId}
            <if test="questionId != 0">
                AND o.question_id = #{questionId}
            </if>
        </where>
        LIMIT #{pageSize} OFFSET #{offset}
    </select>

    <!-- 获取选项数量（限制用户创建的问卷） -->
    <select id="getOptionCount" resultType="int">
        SELECT COUNT(*)
        FROM options o
        JOIN questions q ON o.question_id = q.question_id
        JOIN exam e ON q.exam_id = e.id
        <where>
            e.created_by = #{userId}
            <if test="questionId != 0">
                AND o.question_id = #{questionId}
            </if>
        </where>
    </select>

    <select id="getRowOptionsByQuestionId" resultMap="optionResultMap" parameterType="int">
        SELECT * FROM Options
        WHERE question_id = #{questionId} AND type = '行选项'
        ORDER BY sort_key
    </select>

    <select id="getColumnOptionsByQuestionId" resultMap="optionResultMap" parameterType="int">
        SELECT * FROM Options
        WHERE question_id = #{questionId} AND type = '列选项'
        ORDER BY sort_key
    </select>
</mapper>